{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Parametric Analysis of Graphene TLM Simulation\n",
    "\n",
    "[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/YOUR_USERNAME/tlm-graphene-thz/blob/main/notebooks/02_parametric_analysis.ipynb)\n",
    "\n",
    "This notebook performs a comprehensive parametric study of graphene optical properties, varying:\n",
    "- **Fermi energy** ($E_F$): 0.1 - 1.0 eV\n",
    "- **Relaxation time** ($\\tau$): 10 - 1000 fs\n",
    "\n",
    "The goal is to create 2D maps showing how R, T, A vary with these parameters."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 1. Setup"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Check if running in Colab\n",
    "import sys\n",
    "IN_COLAB = 'google.colab' in sys.modules\n",
    "\n",
    "if IN_COLAB:\n",
    "    !git clone https://github.com/YOUR_USERNAME/tlm-graphene-thz.git 2>/dev/null || true\n",
    "    %cd tlm-graphene-thz\n",
    "    !pip install -q numpy scipy matplotlib tqdm\n",
    "    print(\"âœ… Setup complete!\")\n",
    "else:\n",
    "    import os\n",
    "    if os.path.basename(os.getcwd()) == 'notebooks':\n",
    "        os.chdir('..')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "from matplotlib.colors import Normalize\n",
    "from tqdm.auto import tqdm\n",
    "\n",
    "from src.graphene_model import graphene_RTA_analytical\n",
    "from src.simulation import parametric_study\n",
    "from src.visualization import plot_parametric_map\n",
    "\n",
    "plt.rcParams['figure.dpi'] = 100\n",
    "print(\"âœ… Ready!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 2. Define Parameter Ranges"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# ========================================\n",
    "# ðŸ”§ PARAMETER RANGES\n",
    "# ========================================\n",
    "\n",
    "# Fermi energy range\n",
    "E_F_MIN = 0.1   # eV\n",
    "E_F_MAX = 1.0   # eV\n",
    "N_EF = 20       # Number of points\n",
    "\n",
    "# Relaxation time range\n",
    "TAU_MIN = 10e-15    # s (10 fs)\n",
    "TAU_MAX = 500e-15   # s (500 fs)\n",
    "N_TAU = 20          # Number of points\n",
    "\n",
    "# Frequency range\n",
    "FREQ_MIN = 0.1e12   # Hz\n",
    "FREQ_MAX = 10e12    # Hz\n",
    "N_FREQ = 100        # Number of frequency points\n",
    "\n",
    "# ========================================\n",
    "\n",
    "# Create parameter arrays\n",
    "fermi_energies = np.linspace(E_F_MIN, E_F_MAX, N_EF)\n",
    "relaxation_times = np.linspace(TAU_MIN, TAU_MAX, N_TAU)\n",
    "\n",
    "print(f\"Fermi energies: {N_EF} points from {E_F_MIN} to {E_F_MAX} eV\")\n",
    "print(f\"Relaxation times: {N_TAU} points from {TAU_MIN*1e15:.0f} to {TAU_MAX*1e15:.0f} fs\")\n",
    "print(f\"Total simulations: {N_EF * N_TAU}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 3. Run Parametric Study"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Run parametric study\n",
    "print(\"Running parametric study...\")\n",
    "results = parametric_study(\n",
    "    fermi_energies=fermi_energies,\n",
    "    relaxation_times=relaxation_times,\n",
    "    freq_range=(FREQ_MIN, FREQ_MAX),\n",
    "    n_freq=N_FREQ,\n",
    "    verbose=True\n",
    ")\n",
    "print(\"âœ… Done!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 4. Maximum Absorption Map"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create 2D map of maximum absorption\n",
    "fig, ax = plt.subplots(figsize=(10, 8))\n",
    "\n",
    "TAU_GRID, EF_GRID = np.meshgrid(relaxation_times * 1e15, fermi_energies)\n",
    "\n",
    "c = ax.pcolormesh(TAU_GRID, EF_GRID, results['A_max'], \n",
    "                  cmap='hot', shading='auto')\n",
    "\n",
    "ax.set_xlabel('Relaxation Time Ï„ (fs)', fontsize=12)\n",
    "ax.set_ylabel('Fermi Energy E_F (eV)', fontsize=12)\n",
    "ax.set_title('Maximum Absorption vs Graphene Parameters', fontsize=14)\n",
    "\n",
    "cbar = plt.colorbar(c, ax=ax)\n",
    "cbar.set_label('Maximum Absorption A_max', fontsize=11)\n",
    "\n",
    "# Mark optimal point\n",
    "max_idx = np.unravel_index(np.argmax(results['A_max']), results['A_max'].shape)\n",
    "opt_ef = fermi_energies[max_idx[0]]\n",
    "opt_tau = relaxation_times[max_idx[1]] * 1e15\n",
    "max_A = results['A_max'][max_idx]\n",
    "\n",
    "ax.plot(opt_tau, opt_ef, 'w*', markersize=15, markeredgecolor='black')\n",
    "ax.annotate(f'Max: {max_A:.1%}\\n({opt_ef:.2f} eV, {opt_tau:.0f} fs)',\n",
    "            xy=(opt_tau, opt_ef), xytext=(opt_tau + 50, opt_ef + 0.1),\n",
    "            fontsize=10, color='white',\n",
    "            arrowprops=dict(arrowstyle='->', color='white'))\n",
    "\n",
    "plt.tight_layout()\n",
    "plt.show()\n",
    "\n",
    "print(f\"\\nðŸŽ¯ Optimal parameters for maximum absorption:\")\n",
    "print(f\"   E_F = {opt_ef:.2f} eV\")\n",
    "print(f\"   Ï„ = {opt_tau:.0f} fs\")\n",
    "print(f\"   A_max = {max_A:.1%}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 5. Frequency of Maximum Absorption"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Frequency at which maximum absorption occurs\n",
    "fig, ax = plt.subplots(figsize=(10, 8))\n",
    "\n",
    "c = ax.pcolormesh(TAU_GRID, EF_GRID, results['f_A_max'], \n",
    "                  cmap='viridis', shading='auto')\n",
    "\n",
    "ax.set_xlabel('Relaxation Time Ï„ (fs)', fontsize=12)\n",
    "ax.set_ylabel('Fermi Energy E_F (eV)', fontsize=12)\n",
    "ax.set_title('Frequency of Maximum Absorption', fontsize=14)\n",
    "\n",
    "cbar = plt.colorbar(c, ax=ax)\n",
    "cbar.set_label('Frequency (THz)', fontsize=11)\n",
    "\n",
    "plt.tight_layout()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 6. Absorption Spectra at Different Parameters"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Select specific parameter combinations to compare\n",
    "freq_THz = results['frequency_THz']\n",
    "\n",
    "# Fixed Fermi energy, varying tau\n",
    "ef_idx = N_EF // 2  # Middle value\n",
    "\n",
    "fig, axes = plt.subplots(1, 2, figsize=(14, 5))\n",
    "\n",
    "# Left: Fixed E_F, varying tau\n",
    "for j in range(0, N_TAU, N_TAU//5):\n",
    "    A_spectrum = results['A'][ef_idx, j, :]\n",
    "    tau_fs = relaxation_times[j] * 1e15\n",
    "    axes[0].plot(freq_THz, A_spectrum, linewidth=2, label=f'Ï„={tau_fs:.0f} fs')\n",
    "\n",
    "axes[0].set_xlabel('Frequency (THz)')\n",
    "axes[0].set_ylabel('Absorption A')\n",
    "axes[0].set_title(f'Absorption Spectra (E_F = {fermi_energies[ef_idx]:.2f} eV)')\n",
    "axes[0].legend()\n",
    "axes[0].grid(True, alpha=0.3)\n",
    "axes[0].set_xlim(0, 10)\n",
    "axes[0].set_ylim(0, 0.5)\n",
    "\n",
    "# Right: Fixed tau, varying E_F\n",
    "tau_idx = N_TAU // 2\n",
    "for i in range(0, N_EF, N_EF//5):\n",
    "    A_spectrum = results['A'][i, tau_idx, :]\n",
    "    axes[1].plot(freq_THz, A_spectrum, linewidth=2, label=f'E_F={fermi_energies[i]:.2f} eV')\n",
    "\n",
    "axes[1].set_xlabel('Frequency (THz)')\n",
    "axes[1].set_ylabel('Absorption A')\n",
    "axes[1].set_title(f'Absorption Spectra (Ï„ = {relaxation_times[tau_idx]*1e15:.0f} fs)')\n",
    "axes[1].legend()\n",
    "axes[1].grid(True, alpha=0.3)\n",
    "axes[1].set_xlim(0, 10)\n",
    "axes[1].set_ylim(0, 0.5)\n",
    "\n",
    "plt.tight_layout()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 7. 3D Surface Plot"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "from mpl_toolkits.mplot3d import Axes3D\n",
    "\n",
    "fig = plt.figure(figsize=(12, 8))\n",
    "ax = fig.add_subplot(111, projection='3d')\n",
    "\n",
    "# Create surface plot\n",
    "surf = ax.plot_surface(TAU_GRID, EF_GRID, results['A_max'], \n",
    "                       cmap='hot', edgecolor='none', alpha=0.9)\n",
    "\n",
    "ax.set_xlabel('Relaxation Time Ï„ (fs)')\n",
    "ax.set_ylabel('Fermi Energy E_F (eV)')\n",
    "ax.set_zlabel('Maximum Absorption')\n",
    "ax.set_title('3D View: Maximum Absorption vs Parameters')\n",
    "\n",
    "fig.colorbar(surf, ax=ax, shrink=0.5, aspect=10, label='A_max')\n",
    "\n",
    "ax.view_init(elev=30, azim=45)\n",
    "plt.tight_layout()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 8. Contour Plot with Design Guidelines"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "fig, ax = plt.subplots(figsize=(10, 8))\n",
    "\n",
    "# Contour plot\n",
    "levels = np.linspace(0, results['A_max'].max(), 15)\n",
    "cs = ax.contourf(TAU_GRID, EF_GRID, results['A_max'], levels=levels, cmap='hot')\n",
    "ax.contour(TAU_GRID, EF_GRID, results['A_max'], levels=[0.3, 0.35, 0.4], \n",
    "           colors='white', linewidths=2, linestyles='--')\n",
    "\n",
    "ax.set_xlabel('Relaxation Time Ï„ (fs)', fontsize=12)\n",
    "ax.set_ylabel('Fermi Energy E_F (eV)', fontsize=12)\n",
    "ax.set_title('Graphene Absorber Design Map\\n(contours at A = 30%, 35%, 40%)', fontsize=14)\n",
    "\n",
    "cbar = plt.colorbar(cs, ax=ax)\n",
    "cbar.set_label('Maximum Absorption', fontsize=11)\n",
    "\n",
    "# Add design region\n",
    "ax.axhline(0.4, color='cyan', linestyle=':', linewidth=2, alpha=0.7, label='Typical E_F = 0.4 eV')\n",
    "ax.axvline(100, color='lime', linestyle=':', linewidth=2, alpha=0.7, label='Typical Ï„ = 100 fs')\n",
    "ax.legend(loc='lower right')\n",
    "\n",
    "plt.tight_layout()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 9. Export Results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Save parametric results to file\n",
    "import json\n",
    "\n",
    "export_data = {\n",
    "    'fermi_energies_eV': fermi_energies.tolist(),\n",
    "    'relaxation_times_fs': (relaxation_times * 1e15).tolist(),\n",
    "    'A_max': results['A_max'].tolist(),\n",
    "    'f_A_max_THz': results['f_A_max'].tolist()\n",
    "}\n",
    "\n",
    "with open('parametric_results.json', 'w') as f:\n",
    "    json.dump(export_data, f, indent=2)\n",
    "\n",
    "print(\"âœ… Results saved to parametric_results.json\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Save figures\n",
    "fig, ax = plt.subplots(figsize=(10, 8))\n",
    "c = ax.pcolormesh(TAU_GRID, EF_GRID, results['A_max'], cmap='hot', shading='auto')\n",
    "ax.set_xlabel('Relaxation Time Ï„ (fs)')\n",
    "ax.set_ylabel('Fermi Energy E_F (eV)')\n",
    "ax.set_title('Maximum Absorption vs Graphene Parameters')\n",
    "plt.colorbar(c, ax=ax, label='A_max')\n",
    "plt.savefig('parametric_map.png', dpi=150, bbox_inches='tight')\n",
    "print(\"âœ… Figure saved to parametric_map.png\")\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## ðŸ“Š Summary\n",
    "\n",
    "This parametric study reveals:\n",
    "\n",
    "1. **Higher Fermi energy** â†’ Higher absorption (more carriers)\n",
    "2. **Longer relaxation time** â†’ Sharper absorption peak (less scattering)\n",
    "3. **Optimal design**: Balance between peak absorption and bandwidth\n",
    "\n",
    "For broadband absorbers, use shorter Ï„. For narrow-band, use longer Ï„."
   ]
  }
 ],
 "metadata": {
  "colab": {
   "provenance": []
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.10.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
